<div class="billing-container">
  <!-- Header -->
  <div class="header">
    <h1>Facturación</h1>
    <button mat-raised-button color="accent" (click)="generateMonthlyInvoices()" [disabled]="loading">
      <mat-icon>receipt_long</mat-icon>
      Generar Facturas Mensuales
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid" *ngIf="stats">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #2196f3;">
          <mat-icon>receipt</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{ stats.total }}</h3>
          <p>Total Facturas</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #ff9800;">
          <mat-icon>schedule</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{ stats.pending }}</h3>
          <p>Pendientes</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #f44336;">
          <mat-icon>warning</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{ stats.overdue }}</h3>
          <p>Vencidas</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #4caf50;">
          <mat-icon>attach_money</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{ formatCurrency(stats.totalCommissions) }}</h3>
          <p>Comisiones Totales</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filters -->
  <div class="filters">
    <mat-form-field class="search-field">
      <mat-label>Buscar</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Número de factura, tenant...">
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <mat-form-field class="status-filter">
      <mat-label>Estado</mat-label>
      <mat-select [(value)]="selectedStatus" (selectionChange)="onStatusFilterChange()">
        <mat-option value="all">Todos</mat-option>
        <mat-option value="pending">Pendientes</mat-option>
        <mat-option value="paid">Pagadas</mat-option>
        <mat-option value="overdue">Vencidas</mat-option>
        <mat-option value="cancelled">Canceladas</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando facturas...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !loading" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-button color="primary" (click)="loadInvoices()">Reintentar</button>
  </div>

  <!-- Table -->
  <div *ngIf="!loading && !error" class="table-container">
    <table mat-table [dataSource]="dataSource" matSort class="invoices-table">
      
      <!-- Invoice Number -->
      <ng-container matColumnDef="invoice_number">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Número </th>
        <td mat-cell *matCellDef="let invoice">
          <span class="invoice-number">{{ invoice.invoice_number }}</span>
        </td>
      </ng-container>

      <!-- Tenant -->
      <ng-container matColumnDef="tenant">
        <th mat-header-cell *matHeaderCellDef> Tenant </th>
        <td mat-cell *matCellDef="let invoice">
          <div class="tenant-info">
            <strong>{{ invoice.tenant?.business_name || 'N/A' }}</strong>
            <small>{{ invoice.tenant?.subdomain }}</small>
          </div>
        </td>
      </ng-container>

      <!-- Period -->
      <ng-container matColumnDef="period">
        <th mat-header-cell *matHeaderCellDef> Período </th>
        <td mat-cell *matCellDef="let invoice">
          <div class="period-info">
            <small>{{ formatDate(invoice.billing_period_start) }}</small>
            <small>{{ formatDate(invoice.billing_period_end) }}</small>
          </div>
        </td>
      </ng-container>

      <!-- Appointments -->
      <ng-container matColumnDef="appointments">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Turnos </th>
        <td mat-cell *matCellDef="let invoice">
          {{ invoice.total_appointments }}
        </td>
      </ng-container>

      <!-- Revenue -->
      <ng-container matColumnDef="revenue">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Ingresos </th>
        <td mat-cell *matCellDef="let invoice">
          {{ formatCurrency(invoice.total_revenue) }}
        </td>
      </ng-container>

      <!-- Commission -->
      <ng-container matColumnDef="commission">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Comisión </th>
        <td mat-cell *matCellDef="let invoice">
          <strong>{{ formatCurrency(invoice.commission_amount) }}</strong>
          <small class="commission-rate">({{ invoice.commission_rate * 100 }}%)</small>
        </td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
        <td mat-cell *matCellDef="let invoice">
          <span class="status-badge" [style.background-color]="getStatusColor(invoice.status)">
            {{ getStatusLabel(invoice.status) }}
          </span>
        </td>
      </ng-container>

      <!-- Due Date -->
      <ng-container matColumnDef="due_date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Vencimiento </th>
        <td mat-cell *matCellDef="let invoice">
          <div class="due-date">
            <span>{{ formatDate(invoice.due_date) }}</span>
            <small *ngIf="invoice.status === 'pending'" 
                   [class.text-danger]="getDaysUntilDue(invoice.due_date) < 0"
                   [class.text-warning]="getDaysUntilDue(invoice.due_date) >= 0 && getDaysUntilDue(invoice.due_date) <= 5">
              {{ getDaysUntilDue(invoice.due_date) >= 0 ? getDaysUntilDue(invoice.due_date) + ' días' : 'VENCIDA' }}
            </small>
          </div>
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Acciones </th>
        <td mat-cell *matCellDef="let invoice">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="viewTenant(invoice)">
              <mat-icon>business</mat-icon>
              <span>Ver Tenant</span>
            </button>
            <button mat-menu-item (click)="markAsPaid(invoice)" *ngIf="invoice.status === 'pending' || invoice.status === 'overdue'">
              <mat-icon color="primary">check_circle</mat-icon>
              <span>Marcar como Pagada</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- No data -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          No se encontraron facturas
        </td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" 
                   showFirstLastButtons
                   aria-label="Seleccionar página">
    </mat-paginator>
  </div>
</div>
